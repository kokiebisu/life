# Calendar Sync ルール

## 必須: スケジュール変更時は Notion Calendar も更新する

デイリープラン・週次プラン・ルーティンなどスケジュールに関わるマークダウンファイルを作成・変更したら、**必ず Notion Calendar も同期する。**

1. **新しいデイリープランを作成した場合** → プラン内のタスク・イベントを Notion に登録
2. **既存のスケジュールを変更した場合** → 変更内容を Notion に反映（追加・時間変更）
3. **イベントを別の日に移動した場合** → 移動先に新規登録

### md 編集後の Notion 同期チェック（必須）

md のスケジュール関連ファイルを編集したら、**編集直後に**以下を確認する:

1. 対応する Notion エントリが存在するか？
2. **存在しない** → `notion-add.ts` で新規作成 + ページ内容を書き込む
3. **存在する** → `notion-update-page` でプロパティ・内容を更新する

**並列で複数の更新をするときも、各変更ごとに md ↔ Notion の対応を漏れなく確認する。**「片方だけ更新して完了」にしない。

### スケジュール変更後の全体確認（必須）

ある日のスケジュールを変更（追加・移動・削除）したら、**変更完了後に `notion-list.ts --date` でその日の全エントリを再取得し、以下を確認する:**

1. daily ファイルの全食事・タスクに対応する Notion エントリが存在するか
2. 時間の重複や矛盾がないか
3. 隣接するエントリが意図せず消えていないか

**個別の変更に集中して隣接エントリの消失を見落とさないこと。**

### スケジュール会話の区切りで突き合わせチェック（必須）

スケジュール関連の会話が一段落したら、**影響した日すべてに対して md ↔ Notion の突き合わせを実行する。**完了報告の前にこのチェックを挟むこと。

**手順:**

1. 影響した日を列挙する
2. 各日について `notion-list.ts --date YYYY-MM-DD --json` で Notion の全エントリを取得
3. `daily/YYYY-MM-DD.md` の全食事・タスクと突き合わせる
4. `weekly/*.md` の買い出しリストと Notion groceries エントリを突き合わせる
5. 差分があれば修正する（md → Notion / Notion → md の両方向）

**チェック観点:**
- 全食事に対応する Notion エントリがあるか（抜け漏れ）
- 時間帯に矛盾がないか（重複・移動時間不足）
- md の内容と Notion の内容が一致しているか

CLI コマンドは `/calendar` コマンドを参照。

### 1ブロック = 1タスク（厳守）

- 時間ブロックには**1つのタスクだけ**を入れる
- 「A + B」「A or B」「A / B / C」のような複合タイトルは禁止
- 複数やりたいことがあるなら、別々のブロックに分ける
- 夜の自由時間もその日に1つ選んで入れる（「study / 読書 / 投資」ではなく「読書」など）

### 時間帯の重複禁止（厳守）

**同じ時間帯に複数のエントリを入れない。** ユーザーは基本的に並列で作業しない。

- 登録前に `notion-list.ts --date YYYY-MM-DD --json` で既存エントリを取得し、**時間の重なりがないか確認する**
- 重なりがある場合 → 時間をずらしてから登録する（前後どちらかに寄せる）
- DB が違っても（routine / meals / guitar / events）時間が被ったらNG
- 例: 朝シャワー 08:00-08:30 と朝食 08:00-08:30 → 朝食は 08:30-09:00 にずらす

### 重複エントリ防止（必須）

Notion にイベント・タスクを登録する**前に**、必ず以下の手順を踏む:

1. `notion-list.ts --date YYYY-MM-DD --json` でその日の既存エントリを取得
2. 同名または同内容のエントリが既にあるか確認
3. **既にある場合** → `notion-update-page` でプロパティを更新する（新規追加しない）
4. **ない場合のみ** → 時間帯の重複がないことを確認してから `notion-add.ts` で新規登録する

### キャンセル

予定をキャンセルする場合:

1. **Notion**: 日付プロパティを `null` にクリアしてカレンダーから消す（タイトルは変更しない）
2. **イベントファイル**: キャンセルセクションに記録を残す

### 注意

- **スケジュール変更時は既存の Notion エントリを更新する**（Notion MCP `notion-update-page` で日時プロパティを変更）。二重登録しない
- マークダウンだけ更新して Notion を更新し忘れないこと

## ファイルの使い分け: events/ vs daily/

- **`planning/events/`** — 未来の予定。**一回限りのイベントのみ**
- **`planning/daily/`** — その日の実績・記録用（完了タスク、持ち越し、Feedback 転記）

### ルーティンを events/ に書かない（厳守）

Notion routine DB に既にある繰り返し項目（Devotion、ギター練習、開発、散歩など）は `planning/events/` に書いてはいけない。

- ルーティンは Notion routine DB 側で日時を設定する
- events/ に書くと events DB にも二重登録されてしまう
- 迷ったら「今後も繰り返すか？」で判断。繰り返すなら events/ には書かない

## Notion ページへのコンテンツ反映

コンテンツを持つタスク（ギターレッスン等）を Notion に登録するときは、**ページ本文にも内容を書き込む。**

- `notion-add.ts` でページ作成後、Notion MCP `notion-update-page` の `replace_content` で内容を書き込む
- 詳細な TAB 譜等はリポジトリファイルへの参照リンクを末尾に入れる

### 食事ページのレシピ反映（厳守 — 空ページ絶対禁止）

meals DB に食事を登録したら、**ページ作成直後に必ずレシピを書き込む。後回しにしない。**

**手順（1ページごとにセットで実行）:**

1. `notion-add.ts` でページ作成
2. レシピサイト（クラシル・白ごはん.com 等）から**実在のレシピURL**を検索
3. `notion-update-page` の `replace_content` で**即座に**以下を書き込む:
   - 出典 URL
   - 調理時間
   - 材料リスト（1人前に換算）
   - 作り方の全手順（省略しない）
   - コツ・ポイント
4. **バッチ登録でも省略しない** — 10件あれば10件すべてにレシピを書く

**禁止事項:**
- 空ページのまま放置
- 「後でレシピを追加」と言って先に進む
- 材料だけ書いて手順を省略する

### ギターレッスンの内容反映（必須）

ギター DB にレッスンを登録したら、**必ずレッスンファイルの内容をフルで Notion ページに書き込む:**

1. `aspects/guitar/phase*/lesson-*.md` から該当レッスンを読む
2. **レッスンファイルの全内容を Notion ページに転記する**（要約・省略しない）
3. 空ページのまま登録しない
4. タイトル形式: `Lesson N: タイトル`（講師名はタイトルに含めない）

**Notion フォーマットルール:**

- TAB 譜・指板図・ドリルのお題 → コードブロック（```）で掲載。省略しない
- 講師メモ（瀬戸メモ等） → `<callout icon="📝">` で表示
- 判別表・ルート/5度一覧 → `<table>` で表示
- 講師の語り口調・説明文 → そのまま本文テキストとして記載
- セクション構成 → `##` 見出しでフラットに展開（トグルは使わない）
- **除外するセクション:** 「練習メニュー（1週間）」「次回予告」は Notion ページに含めない（リポジトリのみ）

## デイリープラン作成時の DB 使い分け

デイリープランのルーティンを Notion に登録するとき、**各項目は適切な DB に振り分ける:**

| 項目 | DB | 理由 |
|------|-----|------|
| 食事（朝食・昼食・夕食） | meals | 週次献立（`aspects/diet/weekly/`）からメニュー名・kcal を取得してタイトルに反映 |
| ギター練習 | guitar | カリキュラム（`aspects/guitar/phase*/`）から次のレッスンを取得してタイトルに反映 |
| それ以外のルーティン | routine | 通常のルーティン |

- **食事**: 「朝食」「昼食」「夕食」ではなく、献立名で登録する（例: `ツナとアボカドのサラダ丼`）。週次献立ファイルから該当日のメニューを参照する
- **ギター**: 「ギター練習」ではなく、具体的なレッスン名で登録する（例: `Lesson 3: インターバルを指板で使いこなす（瀬戸）`）

## スケジュールの好み

### ブロック間のバッファ（推奨）

- デイリープランを作るとき、**各ブロックの間に 15 分程度のバッファを入れる**
- 朝のルーティン（Devotion→シャワー→朝食）も含めて全ブロック間にバッファを入れる
- 外出を伴う予定（ジム見学・買い物等）の前後は余裕を持たせる
- バッファなしでびっしり詰めない

### 食事の時間（必須）

- 食事ブロックは**1時間**で確保する（30分は短すぎる）
- 調理＋食事＋片付けを含めてゆとりを持たせる

### ルーティンの頻度目安

| ルーティン | 頻度 | 備考 |
|-----------|------|------|
| 投資リサーチ | 週1回 | 毎日入れなくてよい |

## Feedback の永続反映

Notion タスクに Feedback がある場合、**次回同種のタスク作成時に必ず反映する。**

1. タスク完了時に Feedback を確認
2. 該当 aspect の `CLAUDE.md` に学びとして蓄積
3. 次回同じタスクを立てるとき、過去の Feedback を踏まえた内容にする
