# Notion ワークフロー

## Notion MCP サーバー名

- `ReadMcpResourceTool` のサーバー名は **`claude.ai Notion`**（スペース・ドット入り）
- ツール名の `mcp__claude_ai_Notion__*` と混同しないこと

## 基本方針

- **全イベント・タスクを Notion データベースで管理**
- Notion Calendar で閲覧（Google Calendar と双方向同期）
- タスクには Feedback 欄あり → 翌日 API で取得して次の日のスケジュールに反映

## 操作ルール

- **時間変更時: 前後の予定も連鎖チェックし、かぶりがあれば全部まとめて調整する**
- **タスク追加時: 必ず時間（--start/--end）を入れる**（--allday は使わない）
- **説明・詳細はページ本文に書く**（後述「ページ本文ルール」参照）
- **完了済タスクの追加時**（「〜してた」「〜やった」等）→ ステータスを「完了」にセットする
- **同名エントリがある場合は確認する**: 同名のエントリが既にある場合、既存エントリを勝手に移動・変更せず「同じ名前のエントリがあるけど、新しく追加していい？」とユーザーに確認する
- **重複エントリ防止**: 登録前に `notion-list.ts --date YYYY-MM-DD --json` で既存エントリを取得。同名・同内容があれば `notion-update-page` で更新、ない場合のみ新規登録
- **日付未設定の既存ページに注意**: DB によっては日付未設定のページが既に存在する場合がある（例: ギター DB のレッスンページ）。`notion-list.ts --date` では日付未設定ページは表示されないため、**新規作成する前に Notion MCP（`notion-fetch` でDB を確認するか、ユーザーに既存ページの有無を確認する）**。日付を入れるだけで済む場合は `notion-update-page` でプロパティを更新する

## DB の使い分け

- **todo（やること）**: 一回限りのタスク・作業（申請、書類手続き、メール整理、調べものなど）
- **events（イベント）**: 一回限りの予定で、人と会う・場所に行くもの（飲み会、面談、見学など）
- **routine（習慣）**: 繰り返しやる活動。毎日・毎週やるもの（Devotion、ギター練習、開発など）
- 迷ったら:
  - 「人と会う or 外出する？」→ Yes なら events
  - 「今後も繰り返すか？」→ Yes なら routine
  - どちらでもない作業・タスク → todo

## Notion DB 体制

### Schedule DBs

| DB       | 環境変数              | プロパティ  | ステータス | 用途                             |
| -------- | --------------------- | ----------- | ---------- | -------------------------------- |
| 習慣     | `NOTION_TASKS_DB`     | Name / 日付 | ステータス | 繰り返しルーティン               |
| イベント | `NOTION_EVENTS_DB`    | 名前 / 日付 | ステータス | 一回限りの予定                   |
| ギター   | `NOTION_GUITAR_DB`    | 名前 / 日付 | ステータス | ギター練習・レッスン             |
| 食事     | `NOTION_MEALS_DB`     | 名前 / 日付 | ステータス | 食事メニュー（調理・食べるもの） |
| 買い出し | `NOTION_GROCERIES_DB` | 件名 / 日付 | ステータス | 買い出し・買い物                 |

### Other DBs

- `NOTION_ARTICLES_DB` — 記事（タイトル / ソース / URL / Aspect / Status）
- `NOTION_INVESTMENT_DB` — 投資（Investment / Buy Date / Status / Type / Notes）

## ページ本文ルール（Description プロパティ廃止）

**DB の Description / 説明プロパティは使わない。** 内容はすべてページ本文に書く。

- `--desc` オプションは廃止済み。`notion-add.ts` に渡しても無視される
- 説明・詳細・レシピ・レッスン内容などは、ページ作成後に `notion-update-page` の `replace_content` でページ本文に書き込む
- **手順:** `notion-add.ts` → ページ ID 取得 → `notion-update-page`（`replace_content`）で本文を書く

## Notion 操作の安全ルール

### Notion ページ ID の取り違え防止

複数エントリを一括更新するとき、**更新前に ID→タイトルの対応表を書き出して確認する。** UUID の目視コピーは取り違えやすいため、JSON 出力から ID を拾うときは必ずタイトルとセットで扱う。

### スクリプト実行前に構文を確認する

- `notion-add.ts` 等を呼ぶ前に、必ず正しい引数形式を使う（`--title` 必須）
- 構文が不明なら `--help` や使い方コメントを確認してから実行する
- **間違った構文で試行錯誤しない** — 誤実行が副作用を起こすリスクがある

### 実行後に必ず結果を検証する

- `notion-add.ts` でエントリを追加した後、`notion-list.ts --date` で**追加した対象だけでなく、同じ日の全エントリ**を確認する
- 既存エントリが意図せず消えていないか確認する
- 異常があれば即座にユーザーに報告し、Notion MCP で復旧する

### 削除時はページごと完全削除する

- ユーザーが「消して」「削除して」と言った場合、**日付クリアではなくページごとゴミ箱に入れる**
- ページ削除は `notion-delete.ts` を使う: `bun run scripts/notion-delete.ts <page-id>`
- 複数ページの一括削除にも対応: `bun run scripts/notion-delete.ts <id1> <id2> ...`

### 類似名エントリに注意する

- 「Aパーティ」と「Aパーティ買い出し」のように名前が似たエントリを扱うとき、重複検出の誤判定に注意する
- 重複検出でスキップされた場合、本当に同一エントリか（名前・時間が完全一致か）を確認する
- 誤判定でブロックされたら、Notion MCP（`notion-create-pages`）で直接登録する

## 買い出しリストのフォーマット（統一ルール）

手動・自動を問わず、買い出しリストは以下のフォーマットに従う。

### カテゴリ順（固定）

1. 肉・魚
2. 卵・乳製品
3. 豆腐・納豆
4. 野菜・果物
5. 主食
6. おやつ・その他

### 各食材の記法

```
- [ ] 食材名 量（曜日食事 用途 / 曜日食事 用途）
```

例:
```
- [ ] 豚バラ薄切り 300g（土昼 豚キムチ 150g / 火夜 重ね蒸し 150g）
- [ ] 卵 1パック 10個（土朝2 / 月朝2 / 火朝1 = 5個、残りは②で使用）
```

### カテゴリ見出し

```
### 肉・魚（≒ 900円）
```

小計金額をカテゴリ見出しに入れる。

### 推定合計

```
**推定合計: 約 ¥3,000〜3,500**
```

### 冷凍メモ

買い出し日から2日以上先に使う肉・魚は冷凍メモを追記:

```
### 冷凍メモ
- 豚バラ 150g → 小分けラップして冷凍（火夜 重ね蒸し用）
```

### 価格見積もり

買い出しリストを作成する際は、**必ず `aspects/diet/aoba-prices.csv` を参照して価格を見積もる。**

1. **価格データベースを読み込む**
   - `aspects/diet/aoba-prices.csv` から商品の価格情報を取得
   - 価格が登録されている商品はその価格を使用
   - 価格が未登録の商品は過去の相場から推定

2. **カテゴリごとに小計を計算**
   - 各カテゴリ（肉・魚、卵・乳製品、野菜・果物など）の小計を計算
   - カテゴリ見出しに `（≒ 900円）` の形式で記載

3. **推定合計を計算**
   - 全カテゴリの小計を合算
   - `**推定合計: 約 ¥3,000〜3,500**` の形式で記載
   - 未登録商品がある場合は幅を持たせる

### 自動生成スクリプト

`notion-grocery-gen.ts` で daily 献立から買い出しリスト本文を自動生成できる:

```bash
bun run scripts/notion-grocery-gen.ts --page-id <id>       # ページ指定
bun run scripts/notion-grocery-gen.ts --date 2026-02-17     # 日付から検索
bun run scripts/notion-grocery-gen.ts --date 2026-02-17 --dry-run  # プレビュー
```

**スクリプトは自動的に `aoba-prices.csv` を参照して価格を見積もる。**

### 買い出し後の価格登録ルール

レシート画像を受け取ったら、以下の手順で処理する:

1. **Notion groceries ページに詳細を記録**
   - `mcp__claude_ai_Notion__notion-update-page` で買い出しページ本文に購入内容を記載
   - フォーマット: 店舗、時刻、購入品リスト、合計金額

2. **aspects/diet/aoba-prices.csv に価格を登録**
   - 既存商品の価格が空欄の場合 → 価格・更新日・メモを追加
   - 新規商品の場合 → 新しい行を追加（商品名,カテゴリ,価格,単位,更新日,メモ）
   - メモ欄には店舗名を記載（例: `さわむら`、`aoba`）

3. **ローカルファイルに記録**
   - `aspects/diet/groceries/YYYY-MM-DD.md` にチェックマークと購入内容を追記

**価格CSVフォーマット:**
```csv
商品名,カテゴリ,価格,単位,更新日,メモ
ヨーグルト,卵・乳製品,165,1個,2026-02-17,ブルガリアLB81・さわむら
```

## notion-pull 対象 DB

`notion-pull.ts` は以下の DB を Notion → ローカルファイルに逆同期する:

| DB        | 同期先ファイル                         |
| --------- | -------------------------------------- |
| events    | `planning/events/YYYY-MM-DD.md`        |
| guitar    | `aspects/guitar/events/YYYY-MM-DD.md`  |
| meals     | `aspects/diet/events/YYYY-MM-DD.md`    |
| routine   | `aspects/routine/events/YYYY-MM-DD.md` |
| groceries | `aspects/diet/groceries/YYYY-MM-DD.md` |
| todo      | `planning/tasks.md`（Inbox / Archive） |

- 完了ステータスの判定: `"Done"` or `"完了"` → `[x]` にマーク
- routine DB のステータスプロパティは `ステータス`（日本語）。`Status`（英語）ではない

## スクリプト一覧

共通ライブラリ: `scripts/lib/notion.ts`

CLI コマンドの使い方は `/calendar` コマンドを参照。
