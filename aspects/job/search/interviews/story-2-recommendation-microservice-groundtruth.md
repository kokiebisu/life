---
title: Story 2: Recommendation Microservice @ Groundtruth
created: 2025年12月6日 22:47
updated: 2025年12月9日 21:53
---

# Story 2: Recommendation Microservice @ Groundtruth
**Situation（30秒）**
Groundtruthはニューヨークに本社を置く位置情報マーケティング会社。ユーザーが広告キャンペーンを作成する際、Ads Managerでセグメントをドロップダウンから選択する必要があったが、選択肢が肥大化し、開発者ですら管理が困難な状態だった。Google Analyticsでドロップダウン選択時点での離脱や、効果的でないセグメントの選択が多発していた。キャンペーン効果が出ないと広告主が他社へ離れてしまうため、重要な課題だった。

**Task（15秒）**
5人のエンジニアチームの一員として、レコメンデーションマイクロサービスのバックエンド構築を担当。未経験ユーザー向けにドロップダウンをシンプル化し、経験のあるユーザーにはパーソナライズされたセグメントの提案ができるようにすること。

**Action（1分）**
FastAPIとOpenSearchでマイクロサービスを構築した。既存のAds ManagerはFlaskで書かれており、並列処理がリソース効率的にできなかったため、検索エンジンに適したスタックを選定した。

2つのレコメンデーション機能を実装：

- **Top 5 Popular Options（未経験ユーザー向け）**: 定期cronで毎月最も選択されたセグメントをCSVに算出し、ドロップダウンをシンプル化
- **Personalized Suggestions（経験ユーザー向け）**: AI基盤チームのLLMモデルがユーザーのこれまでの行動を学習。そのエンドポイントからデータを受け取り、マイクロサービスで整形してAds Managerに返す設計にした。

**Result（30秒）**
Google Analyticsで計測した結果、キャンペーン作成時のchurn（離脱）が20%削減された。

- レスポンス形式の調整（MLチームが返すデータ形式とAds Managerが求める形式のギャップ）
- レイテンシの問題（MLモデルの推論時間が長く、UXに影響）
- エラーハンドリング（MLエンドポイントが落ちた時のフォールバック）
- チーム間のコミュニケーション（タイムゾーンの違い、優先度の違いなど）

**Q: この経験から何を学んだ？**

### 技術面

**1. 問題に適した技術選定の重要性**
既存のFlaskで無理やり実装するのではなく、並列処理が必要な検索エンジンにはFastAPI（ASGI）が適していると判断した。技術選定は「今あるもの」ではなく「問題に最適なもの」を選ぶべきだと学んだ。

**2. マイクロサービス化のタイミング判断**
すべてをマイクロサービス化する必要はないが、デプロイ頻度やパフォーマンス要件が異なる機能は切り離すべき。今回は検索エンジンのトラフィックがメインアプリのボトルネックになるリスクがあったため、切り離しが正解だった。

**3. 外部チームとの連携時のフォールバック設計**
MLエンドポイントのような外部依存がある場合、必ず落ちる前提で設計する必要がある。今回はMLが落ちた場合にTop 5 Popularを表示するフォールバックを用意した。これにより、ユーザー体験を損なわずに済んだ。

---

### プロダクト面

**4. ユーザーセグメントごとに異なるソリューションを設計する**
未経験ユーザーと経験ユーザーでは求めるものが違う。未経験者にはシンプルなTop 5、経験者にはパーソナライズされた提案。一つのソリューションで全員を満足させようとせず、セグメントごとに最適な体験を設計することが重要。

**5. データに基づいて課題を特定し、効果を計測する**
Google Analyticsでドロップダウンでの離脱を発見し、同じくGoogle Analyticsでchurn 20%削減を計測した。感覚ではなくデータで課題を特定し、効果を証明することで、チームやステークホルダーの納得感を得られた。

---

### チーム面

**6. タイムゾーンや優先度が異なるチームとの連携**
MLチームとは優先度やスケジュールが異なることがあった。事前にインターフェース（API仕様）を明確に決め、お互いの依存を最小化することで、スムーズに進められた。

**7. 自チームのデプロイ自由度を確保するアーキテクチャ判断**
Ads Managerのデプロイサイクルに縛られると、素早い改善ができない。マイクロサービス化することで、自チームのペースでイテレーションを回せるようになった。アーキテクチャ判断がチームの生産性に直結すると実感した。
