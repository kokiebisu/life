# Calendar Sync ルール

## 睡眠ルール（厳守）

- **目標: 22:00 就寝 → 5:00 起床**（7時間睡眠）
- **理想就寝: 23:00 / MUST: 24:00**（これより遅くなるスケジュールは組まない）
- **睡眠時間は必ず7時間確保する**（就寝が遅れたら起床もずらす）
- デイリープラン作成時、24:00 以降にタスクを配置しない
- 外出イベントの帰宅時間が 24:00 を超える場合はユーザーに警告する

---

## Cross-DB 重複自動解決（from:notion 実行時）

`notion-pull.ts` はDB間の時間重複を自動的に解決する。優先度の高いDB のエントリが低いDBのエントリに勝ち、重複する低優先エントリは Notion から削除される。

**DB 優先度（高→低）:** events > todo > guitar > meals > routine > groceries

**例:**
- デート（events, 19:00-22:00）と夕食（meals, 19:00-20:00）→ 夕食を削除（デートで食事する）
- イベント（events）と Devotion（routine）→ Devotion を削除（ルーティン同期が別の時間に再配置する）

**ポイント:**
- 手動でNotionにイベントを追加した後に `from:notion` を実行すると、自動エントリとの重複が解消される
- 削除されたルーティンは `notion-sync-schedule.ts` が空き時間に再配置する
- 同じDB内のエントリ同士は重複解決の対象外（ユーザーが意図的に配置したと判断）

---

## スケジュール変更時の全プロパティ更新（厳守）

ユーザーが時間変更を伝えたら、**関連するすべてのフィールドを漏れなく更新する。**

- `日付`（date プロパティ: start / end）
- `開始時間`・`終了時間`（テキストプロパティ）
- md ファイルの時間表記（ヘッダ行 + 🕐行）

**1つだけ更新して他を放置しない。** チェックリスト:
1. Notion `日付` プロパティ（start/end）を更新
2. Notion `開始時間`・`終了時間` プロパティを更新
3. md ファイルの該当行を更新
4. 更新後に `notion-fetch` で全プロパティが一致しているか確認

---

## 移動時間の考慮（厳守）

連続するエントリが**異なる場所**にある場合、**移動時間を必ず確保する。**

### ルール

- エントリ登録・変更時に、前後のエントリの `場所` を確認する
- 場所が異なる場合、Google Maps 等で移動時間を見積もる（不明なら徒歩15分・電車30分をデフォルトとする）
- 移動時間分のバッファがない場合、前のエントリの終了時間を早めるか、後のエントリの開始時間を遅らせる
- md ファイルの 🕐 行に移動時間を明記する: `🕐 HH:MM-HH:MM（移動XX分: 出発地→目的地）`

### 目安（横浜エリア）

| ルート | 所要時間 |
|--------|----------|
| 桜木町・県立図書館 ↔ 日ノ出町 | 徒歩15分 |
| 桜木町 ↔ 横浜駅 | 徒歩15分 / 電車5分 |
| 桜木町 ↔ お茶の水 | 電車50分 |
| 桜木町 ↔ 渋谷 | 電車35分 |

### チェックタイミング

- 新規エントリ登録時
- 既存エントリの時間・場所変更時
- デイリープラン作成時

---

## イベント登録時の必須チェックリスト（厳守）

**新しいイベント・タスクを登録するときは、以下を必ず実行する:**

### 1. 時間重複チェック（登録前）
- `notion-list.ts --date YYYY-MM-DD --json` で既存エントリを取得
- 登録予定の時間帯に既存エントリがないか確認
- **重複がある場合は時間をずらす**（前後どちらかに寄せる）
- DB が違っても（routine / meals / guitar / events / todo）時間が被ったらNG
- 例: 朝シャワー 08:00-08:30 と朝食 08:00-08:30 → 朝食は 08:30-09:00 にずらす

### 2. DB 選択
- `notion-workflow.md` の「DB の使い分け」を参照

### 3. md と Notion の両方に登録（必須）
- Notion に登録したら `planning/events/` または `daily/` にも記載
- md に書いたら Notion にも登録
- **片方だけで終わらせない**（不整合の原因）

### 4. 登録後の全体確認
- `notion-list.ts --date YYYY-MM-DD` で登録した日の全エントリを確認
- 時間重複がないか再チェック
- md と Notion の内容が一致しているか確認

---

## 必須: スケジュール変更時は Notion Calendar も更新する

デイリープラン・週次プラン・ルーティンなどスケジュールに関わるマークダウンファイルを作成・変更したら、**必ず Notion Calendar も同期する。**

1. **新しいデイリープランを作成した場合** → プラン内のタスク・イベントを Notion に登録
2. **既存のスケジュールを変更した場合** → 変更内容を Notion に反映（追加・時間変更）
3. **イベントを別の日に移動した場合** → 移動先に新規登録

### md 編集後の Notion 同期チェック（必須）

md のスケジュール関連ファイルを編集したら、**編集直後に**以下を確認する:

1. 対応する Notion エントリが存在するか？
2. **存在しない** → `notion-add.ts` で新規作成 + ページ内容を書き込む
3. **存在する** → `notion-update-page` でプロパティ・内容を更新する

**並列で複数の更新をするときも、各変更ごとに md ↔ Notion の対応を漏れなく確認する。**「片方だけ更新して完了」にしない。

### スケジュール変更後の全体確認（必須）

ある日のスケジュールを変更（追加・移動・削除）したら、**変更完了後に `notion-list.ts --date` でその日の全エントリを再取得し、以下を確認する:**

1. daily ファイルの全食事・タスクに対応する Notion エントリが存在するか
2. 時間の重複や矛盾がないか
3. 隣接するエントリが意図せず消えていないか

**個別の変更に集中して隣接エントリの消失を見落とさないこと。**

### 曜日の明示的確認（必須）

スケジュール作業時は**必ず曜日を明示的に確認する。** 曜日を推測・暗算せず、コマンドで確認すること。

**確認方法:**
```bash
# 特定日の曜日を確認
TZ=Asia/Tokyo date -d "2026-02-22" "+%Y-%m-%d (%a)"

# カレンダー全体を表示
cal 2 2026
```

**曜日確認が必須の場面:**
- イベント・タスクの日付を決める時
- 「教会（日曜）」「平日」など曜日依存の予定を扱う時
- ユーザーに日程を提案・報告する時

**報告時のフォーマット:**
- 必ず「2/22（日）」のように曜日を併記する

**なぜ必要か:**
- 日付から曜日を暗算すると間違える
- 曜日が違うとスケジュール全体が破綻する（教会を土曜に入れる、など）

### スケジュール会話の区切りで突き合わせチェック（必須）

スケジュール関連の会話が一段落したら、**影響した日すべてに対して md ↔ Notion の突き合わせを実行する。**完了報告の前にこのチェックを挟むこと。

**手順:**

1. 影響した日を列挙する
2. 各日について `notion-list.ts --date YYYY-MM-DD --json` で Notion の全エントリを取得
3. `daily/YYYY-MM-DD.md` の全食事・タスクと突き合わせる
4. `weekly/*.md` の買い出しリストと Notion groceries エントリを突き合わせる
5. 差分があれば修正する（md → Notion / Notion → md の両方向）

**チェック観点:**
- 全食事に対応する Notion エントリがあるか（抜け漏れ）
- 時間帯に矛盾がないか（重複・移動時間不足）
- md の内容と Notion の内容が一致しているか

CLI コマンドは `/calendar` コマンドを参照。

### 1ブロック = 1タスク（厳守）

- 時間ブロックには**1つのタスクだけ**を入れる
- 「A + B」「A or B」「A / B / C」のような複合タイトルは禁止
- 複数やりたいことがあるなら、別々のブロックに分ける
- 夜の自由時間もその日に1つ選んで入れる（「study / 読書 / 投資」ではなく「読書」など）

### キャンセル

予定をキャンセルする場合:

1. **Notion**: `notion-delete.ts` でページごと削除する（日付クリアではなく完全削除）
2. **イベントファイル**: キャンセルセクションに記録を残す

### 注意

- **スケジュール変更時は既存の Notion エントリを更新する**（Notion MCP `notion-update-page` で日時プロパティを変更）。二重登録しない
- マークダウンだけ更新して Notion を更新し忘れないこと

## ファイルの使い分け: events/ vs daily/

- **`planning/events/`** — 未来の予定。**一回限りのイベントのみ**
- **`planning/daily/`** — その日の実績・記録用（完了タスク、持ち越し、Feedback 転記）

## 重複解決ルール（Conflict Resolution）

`schedule.json` の `conflictRules` に基づく。

### ルール

- **events / todo**: keep（絶対に動かさない）
- **Devotion**: shift（後ろにずらす。削除禁止）
- **meals**: delete（外食イベントと重複したら削除）
- **groceries**: delete
- **routine（その他）/ guitar**: shift

### Claude の対応

デイリープラン生成後、`conflictResolutions` を確認:
- `delete` → `notion-delete.ts` で Notion ページ削除
- `shift` → `notion-update-page` で時間変更
- `shrink` → `notion-update-page` で時間変更

---

### ルーティンを events/ に書かない（厳守）

Notion routine DB に既にある繰り返し項目（Devotion、ギター練習、開発、散歩など）は `planning/events/` に書いてはいけない。

- ルーティンは Notion routine DB 側で日時を設定する
- events/ に書くと events DB にも二重登録されてしまう
- 迷ったら「今後も繰り返すか？」で判断。繰り返すなら events/ には書かない
