name: Daily Plan
on:
  schedule:
    - cron: '0 19 * * *' # 04:00 JST (19:00 UTC)
  workflow_dispatch:
    inputs:
      date:
        description: '対象日 (YYYY-MM-DD)。空欄なら今日(JST)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile

      - name: Generate daily plan
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_TASKS_DB: ${{ secrets.NOTION_TASKS_DB }}
          NOTION_EVENTS_DB: ${{ secrets.NOTION_EVENTS_DB }}
          NOTION_GUITAR_DB: ${{ secrets.NOTION_GUITAR_DB }}
          NOTION_MEALS_DB: ${{ secrets.NOTION_MEALS_DB }}
          NOTION_GROCERIES_DB: ${{ secrets.NOTION_GROCERIES_DB }}
          NOTION_TODO_DB: ${{ secrets.NOTION_TODO_DB }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
        run: |
          DATE="${{ inputs.date || '' }}"
          if [ -z "$DATE" ]; then DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d); fi
          OUTPUT="planning/daily/${DATE}.md"
          mkdir -p planning/daily
          bun run scripts/notion-daily-plan.ts --date "$DATE" --ai > "$OUTPUT"

      - name: Sync event files to Notion
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_TASKS_DB: ${{ secrets.NOTION_TASKS_DB }}
          NOTION_EVENTS_DB: ${{ secrets.NOTION_EVENTS_DB }}
          NOTION_GUITAR_DB: ${{ secrets.NOTION_GUITAR_DB }}
          NOTION_MEALS_DB: ${{ secrets.NOTION_MEALS_DB }}
          NOTION_GROCERIES_DB: ${{ secrets.NOTION_GROCERIES_DB }}
          NOTION_TODO_DB: ${{ secrets.NOTION_TODO_DB }}
        run: |
          DATE="${{ inputs.date || '' }}"
          if [ -z "$DATE" ]; then DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d); fi
          for f in planning/events/${DATE}.md aspects/*/events/${DATE}.md; do
            if [ -f "$f" ]; then
              echo "Syncing $f..."
              bun run scripts/notion-sync-event-file.ts --file "$f"
            fi
          done

      - name: Sync routine schedule to Notion Calendar
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_TASKS_DB: ${{ secrets.NOTION_TASKS_DB }}
          NOTION_EVENTS_DB: ${{ secrets.NOTION_EVENTS_DB }}
          NOTION_GUITAR_DB: ${{ secrets.NOTION_GUITAR_DB }}
          NOTION_MEALS_DB: ${{ secrets.NOTION_MEALS_DB }}
          NOTION_GROCERIES_DB: ${{ secrets.NOTION_GROCERIES_DB }}
          NOTION_TODO_DB: ${{ secrets.NOTION_TODO_DB }}
        run: |
          DATE="${{ inputs.date || '' }}"
          if [ -z "$DATE" ]; then DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d); fi
          bun run scripts/notion-sync-schedule.ts --date "$DATE"

      - name: Commit and push
        run: |
          DATE="${{ inputs.date || '' }}"
          if [ -z "$DATE" ]; then DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d); fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add planning/daily/
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "chore: daily plan ${DATE}"
          git push
