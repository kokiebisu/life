# Calendar Sync ルール

## 睡眠ルール（厳守）

- **目標: 22:00 就寝 → 5:00 起床**（7時間睡眠）
- **理想就寝: 23:00 / MUST: 24:00**（これより遅くなるスケジュールは組まない）
- **睡眠時間は必ず7時間確保する**（就寝が遅れたら起床もずらす）
- デイリープラン作成時、24:00 以降にタスクを配置しない
- 外出イベントの帰宅時間が 24:00 を超える場合はユーザーに警告する

## イベント候補日の提案時は天気を考慮する

ユーザーが「いつがいい？」「候補日は？」と聞いてきたとき、または日程を選べるイベントを登録するとき:

1. `bun run scripts/weather.ts --date YYYY-MM-DD --date YYYY-MM-DD ... --json` で候補日の天気を取得
2. 外出おすすめ度（`score`）を判断材料に加える
3. 天気が悪い日（score 1-2）は「雨の可能性あり」等を添えて候補から下げる
4. 複数候補がある場合、天気が良い日を優先的に提案する

**対象:** 外出を伴うイベント（飲み会、遊び、買い出しなど）。在宅作業系のタスクには天気チェック不要。

**注意:** Open-Meteo API は最大16日先まで。それ以降は天気情報なしで提案する。

---

## イベント登録時の必須チェックリスト（厳守）

**新しいイベント・タスクを登録するときは、以下を必ず実行する:**

### 1. 時間重複チェック（登録前）
- `notion-list.ts --date YYYY-MM-DD --json` で既存エントリを取得
- 登録予定の時間帯に既存エントリがないか確認
- **重複がある場合は時間をずらす**（前後どちらかに寄せる）
- DB が違っても（routine / meals / guitar / events / todo）時間が被ったらNG

### 2. DB 選択の確認
- **todo**: 一回限りの作業・タスク（書類、申請、調べもの等）
- **events**: 一回限りの予定（人と会う・外出する）
- **routine**: 繰り返しやる活動（毎日・毎週やるもの）
- **デスクワーク・書類手続き系は必ず todo DB**（events DB には入れない）

### 3. md と Notion の両方に登録（必須）
- Notion に登録したら `planning/events/` または `daily/` にも記載
- md に書いたら Notion にも登録
- **片方だけで終わらせない**（不整合の原因）

### 4. 登録後の全体確認
- `notion-list.ts --date YYYY-MM-DD` で登録した日の全エントリを確認
- 時間重複がないか再チェック
- md と Notion の内容が一致しているか確認

---

## ご飯イベント翌日の朝スケジュール調整

前日に**ご飯のイベント**（飲み会・食事会・新年会など）がある日は、翌朝のスケジュールを以下のように調整する:

1. **Devotion を 7:30-8:30 に変更**（通常より遅めスタート）
2. **朝シャワーを 8:30-9:00 に変更**（Devotion の直後）
3. **朝食を 9:00-10:00 に変更**（朝食は必ず1時間確保）
4. **後続エントリの連鎖調整** — 朝食以降に重複が発生する場合、後続のエントリを臨機応変にずらす
5. **収まらない場合は一旦外す** — タスクが多すぎて午前中に収まらない場合、優先度の低いタスクを別の日に移動するか一旦外す

**ご飯イベントの判定基準:**
- タイトルに「ご飯」「飲み会」「新年会」「食事」等が含まれる
- 夕方〜夜の時間帯（概ね18:00以降）に開催される外食・会食イベント

---

## 必須: スケジュール変更時は Notion Calendar も更新する

デイリープラン・週次プラン・ルーティンなどスケジュールに関わるマークダウンファイルを作成・変更したら、**必ず Notion Calendar も同期する。**

1. **新しいデイリープランを作成した場合** → プラン内のタスク・イベントを Notion に登録
2. **既存のスケジュールを変更した場合** → 変更内容を Notion に反映（追加・時間変更）
3. **イベントを別の日に移動した場合** → 移動先に新規登録

### md 編集後の Notion 同期チェック（必須）

md のスケジュール関連ファイルを編集したら、**編集直後に**以下を確認する:

1. 対応する Notion エントリが存在するか？
2. **存在しない** → `notion-add.ts` で新規作成 + ページ内容を書き込む
3. **存在する** → `notion-update-page` でプロパティ・内容を更新する

**並列で複数の更新をするときも、各変更ごとに md ↔ Notion の対応を漏れなく確認する。**「片方だけ更新して完了」にしない。

### スケジュール変更後の全体確認（必須）

ある日のスケジュールを変更（追加・移動・削除）したら、**変更完了後に `notion-list.ts --date` でその日の全エントリを再取得し、以下を確認する:**

1. daily ファイルの全食事・タスクに対応する Notion エントリが存在するか
2. 時間の重複や矛盾がないか
3. 隣接するエントリが意図せず消えていないか

**個別の変更に集中して隣接エントリの消失を見落とさないこと。**

### 曜日の明示的確認（必須）

スケジュール作業時は**必ず曜日を明示的に確認する。** 曜日を推測・暗算せず、コマンドで確認すること。

**確認方法:**
```bash
# 特定日の曜日を確認
TZ=Asia/Tokyo date -d "2026-02-22" "+%Y-%m-%d (%a)"

# カレンダー全体を表示
cal 2 2026
```

**曜日確認が必須の場面:**
- イベント・タスクの日付を決める時
- 「教会（日曜）」「平日」など曜日依存の予定を扱う時
- ユーザーに日程を提案・報告する時

**報告時のフォーマット:**
- 必ず「2/22（日）」のように曜日を併記する
- 曜日を間違えた場合、ユーザーがすぐに気づける

**なぜ必要か:**
- 日付から曜日を暗算すると間違える
- 曜日が違うとスケジュール全体が破綻する（教会を土曜に入れる、など）
- ユーザーは曜日感覚で生活している

### スケジュール会話の区切りで突き合わせチェック（必須）

スケジュール関連の会話が一段落したら、**影響した日すべてに対して md ↔ Notion の突き合わせを実行する。**完了報告の前にこのチェックを挟むこと。

**手順:**

1. 影響した日を列挙する
2. 各日について `notion-list.ts --date YYYY-MM-DD --json` で Notion の全エントリを取得
3. `daily/YYYY-MM-DD.md` の全食事・タスクと突き合わせる
4. `weekly/*.md` の買い出しリストと Notion groceries エントリを突き合わせる
5. 差分があれば修正する（md → Notion / Notion → md の両方向）

**チェック観点:**
- 全食事に対応する Notion エントリがあるか（抜け漏れ）
- 時間帯に矛盾がないか（重複・移動時間不足）
- md の内容と Notion の内容が一致しているか

CLI コマンドは `/calendar` コマンドを参照。

### 1ブロック = 1タスク（厳守）

- 時間ブロックには**1つのタスクだけ**を入れる
- 「A + B」「A or B」「A / B / C」のような複合タイトルは禁止
- 複数やりたいことがあるなら、別々のブロックに分ける
- 夜の自由時間もその日に1つ選んで入れる（「study / 読書 / 投資」ではなく「読書」など）

### 時間帯の重複禁止（厳守）

**同じ時間帯に複数のエントリを入れない。** ユーザーは基本的に並列で作業しない。

- 登録前に `notion-list.ts --date YYYY-MM-DD --json` で既存エントリを取得し、**時間の重なりがないか確認する**
- 重なりがある場合 → 時間をずらしてから登録する（前後どちらかに寄せる）
- DB が違っても（routine / meals / guitar / events）時間が被ったらNG
- 例: 朝シャワー 08:00-08:30 と朝食 08:00-08:30 → 朝食は 08:30-09:00 にずらす

### 食事変更時は買い出しリストも連動更新（必須）

食事メニューを**移動・削除・差し替え**したら、**対応する買い出しリスト（Notion groceries ページ）も必ず更新する。**

**更新手順（スクリプトで再生成）:**
1. `aspects/diet/daily/` の献立ファイルを先に更新する
2. `notion-grocery-gen.ts` で買い出しページを再生成する
3. **手動で Notion ページを編集しない**（オシャレなフォーマットが崩れるため）

```bash
# 日付指定で再生成
bun run scripts/notion-grocery-gen.ts --date 2026-02-18

# プレビュー（Notionに書き込まない）
bun run scripts/notion-grocery-gen.ts --date 2026-02-18 --dry-run
```

**なぜ手動編集NG:**
- スクリプトは callout・toggle heading・emoji・価格見積もりなどオシャレなフォーマットで出力する
- 手動編集するとフォーマットが崩れ、見づらくなる
- 献立変更 → daily ファイル更新 → スクリプト再生成、の流れを守る

### キャンセル

予定をキャンセルする場合:

1. **Notion**: 日付プロパティを `null` にクリアしてカレンダーから消す（タイトルは変更しない）
2. **イベントファイル**: キャンセルセクションに記録を残す

### 注意

- **スケジュール変更時は既存の Notion エントリを更新する**（Notion MCP `notion-update-page` で日時プロパティを変更）。二重登録しない
- マークダウンだけ更新して Notion を更新し忘れないこと

## ファイルの使い分け: events/ vs daily/

- **`planning/events/`** — 未来の予定。**一回限りのイベントのみ**
- **`planning/daily/`** — その日の実績・記録用（完了タスク、持ち越し、Feedback 転記）

### 日曜・音響当番の日はスケジュールを前倒しする

音響当番（サウンドチーム）の日は教会に **9:00** 到着が必要（通常は13:00）。デイリープラン作成時:

- 起床・シャワー・朝食をすべて前倒しする（朝食は遅くとも 8:00 までに終える）
- 音響当番かどうかはユーザーに確認する（毎週ではない）
- 通常の日曜（13:00〜）と音響当番の日曜（9:00〜）で教会の時間枠が異なることに注意

### 移動時間の自動管理

外出を伴うイベント（`@ 場所名` があるもの）を登録するとき、**移動時間を含めたブロックで登録する。**

**ワークフロー:**

1. イベントに場所がある（タイトルに `@ location`）場合、移動元を確認する
   - 前のイベントの `場所` プロパティがあればそこから出発
   - なければユーザーの自宅（**MEMORY.md の住所をそのまま `--from` に渡す。駅名や略称ではなく、必ず正式な住所を使うこと**）
2. `travel-time.ts` で移動時間を見積もる（`--from` には MEMORY.md の正式住所を使う）
   ```bash
   bun run scripts/travel-time.ts --from "<MEMORY.mdの住所>" --to "藤沢善行" --json
   ```
3. 移動時間込みの `--start`/`--end` と実際の `--actual-start`/`--actual-end` で登録
   ```bash
   bun run scripts/notion-add.ts \
     --title "バレーボール @ 藤沢善行" \
     --date 2026-02-17 \
     --start 18:00 --end 21:30 \
     --actual-start 18:30 --actual-end 21:00 \
     --location "神奈川県藤沢市善行7-1-2" \
     --db events
   ```
4. 場所が不明確な場合はユーザーに確認する

**プロパティの使い分け:**
- `日付`（既存）= 移動込みブロック（例: 18:00-21:30）
- `開始時間`（rich_text）= 実際のイベント開始時刻（例: "18:30"）
- `終了時間`（rich_text）= 実際のイベント終了時刻（例: "21:00"）
- `場所`（rich_text）= API 用の正確な住所（例: "神奈川県藤沢市善行7-1-2"）
- タイトルの `@ 略称` = 表示用（例: `バレーボール @ 藤沢善行`）
- `場所` が空 = 自宅（Claude が MEMORY.md の住所を使用）

**帰宅の移動時間:**
- イベント終了後の帰宅時間も `--end` に含める（例: イベント 21:00 終了 + 帰宅 30分 = `--end 21:30`）
- `--actual-end` にはイベント自体の終了時刻を入れる

### ルーティンを events/ に書かない（厳守）

Notion routine DB に既にある繰り返し項目（Devotion、ギター練習、開発、散歩など）は `planning/events/` に書いてはいけない。

- ルーティンは Notion routine DB 側で日時を設定する
- events/ に書くと events DB にも二重登録されてしまう
- 迷ったら「今後も繰り返すか？」で判断。繰り返すなら events/ には書かない

