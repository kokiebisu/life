name: Daily Plan
on:
  schedule:
    - cron: '0 19 * * *' # 04:00 JST (19:00 UTC)
  workflow_dispatch: # 手動トリガー

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile

      - name: Generate daily plan
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_TASKS_DB: ${{ secrets.NOTION_TASKS_DB }}
          NOTION_JOURNAL_DB: ${{ secrets.NOTION_JOURNAL_DB }}
        run: |
          DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          OUTPUT="aspects/planning/daily/${DATE}.md"
          mkdir -p aspects/planning/daily
          bun run scripts/notion-daily-plan.ts --date "$DATE" > "$OUTPUT"

      - name: Sync schedule to Notion Calendar
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_TASKS_DB: ${{ secrets.NOTION_TASKS_DB }}
          NOTION_JOURNAL_DB: ${{ secrets.NOTION_JOURNAL_DB }}
        run: |
          DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          bun run scripts/notion-sync-schedule.ts --date "$DATE"

      - name: Commit and push
        run: |
          DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add aspects/planning/daily/
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "chore: daily plan ${DATE}"
          git push
